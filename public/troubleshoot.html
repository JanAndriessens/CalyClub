<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DÃ©pannage - CalyBase</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .troubleshoot-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .issue-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .solution-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: bold;
        }
        .solution-button:hover {
            background: #0056b3;
        }
        .danger-button {
            background: #dc3545;
        }
        .danger-button:hover {
            background: #c82333;
        }
        .success-button {
            background: #28a745;
        }
        .success-button:hover {
            background: #218838;
        }
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ok {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-unknown {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo-container">
            <div class="logo-image">
                <img src="images/CalypsoDC-VerticPos_rvb.png" alt="CalypsoDC Logo">
            </div>
            <div class="logo-text-container">
                <div class="logo-text">CalyBase</div>
                <div class="username-text" id="usernameText" style="display: none;"></div>
            </div>
        </div>
        <div class="nav-links">
            <a href="/">Accueil</a>
            <a href="/membres.html">Membres</a>
            <a href="/login.html">DÃ©connexion</a>
        </div>
    </nav>

    <div class="troubleshoot-container">
        <h1>ğŸ”§ DÃ©pannage CalyBase</h1>
        <p>Cette page vous aide Ã  rÃ©soudre les problÃ¨mes courants avec CalyBase.</p>

        <!-- System Status -->
        <div class="issue-card">
            <h3>ğŸ“Š Ã‰tat du systÃ¨me</h3>
            <div id="systemStatus">
                <p>VÃ©rification en cours...</p>
            </div>
            <button class="solution-button" id="checkStatusBtn">ğŸ”„ VÃ©rifier l'Ã©tat</button>
        </div>

        <!-- Firebase Issues -->
        <div class="issue-card">
            <h3>ğŸ”¥ ProblÃ¨mes Firebase</h3>
            <p><strong>SymptÃ´mes:</strong></p>
            <ul>
                <li>Message "firebase.storage is not a function"</li>
                <li>Erreur de persistance Firestore</li>
                <li>DonnÃ©es en cache obsolÃ¨tes</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <button class="solution-button danger-button" id="clearCacheBtn">ğŸ§¹ Nettoyer le cache Firebase</button>
            <button class="solution-button" id="reloadPageBtn">ğŸ”„ Actualiser la page</button>
        </div>

        <!-- Authentication Issues -->
        <div class="issue-card">
            <h3>ğŸ” ProblÃ¨mes d'authentification</h3>
            <p><strong>SymptÃ´mes:</strong></p>
            <ul>
                <li>Impossible de se connecter</li>
                <li>DÃ©connexion automatique</li>
                <li>Pages protÃ©gÃ©es inaccessibles</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <button class="solution-button" id="forceLogoutBtn">ğŸšª Forcer la dÃ©connexion</button>
            <button class="solution-button success-button" id="goToLoginBtn">ğŸ‘¤ Aller Ã  la connexion</button>
        </div>

        <!-- Browser Issues -->
        <div class="issue-card">
            <h3>ğŸŒ ProblÃ¨mes de navigateur</h3>
            <p><strong>SymptÃ´mes:</strong></p>
            <ul>
                <li>Pages qui ne se chargent pas</li>
                <li>JavaScript dÃ©sactivÃ©</li>
                <li>Cookies bloquÃ©s</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <button class="solution-button" id="checkBrowserBtn">ğŸ” VÃ©rifier le navigateur</button>
            <button class="solution-button danger-button" id="clearAllDataBtn">ğŸ—‘ï¸ Vider tout le cache navigateur</button>
        </div>

        <!-- Manual Diagnostics -->
        <div class="issue-card">
            <h3>ğŸ©º Diagnostics</h3>
            <p>Informations techniques pour le support:</p>
            <div id="diagnosticInfo" style="background: #f1f3f4; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
            Cliquez sur "GÃ©nÃ©rer rapport" pour afficher les informations de diagnostic
            </div>
            <button class="solution-button" id="generateReportBtn">ğŸ“‹ GÃ©nÃ©rer rapport de diagnostic</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="firebase-config.js"></script>
    <script src="clear-cache.js"></script>
    <script src="firebase-app.js"></script>
    <script src="navigation.js"></script>

    <script>
        // System status check
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = `
                <p>Firebase SDK: ${typeof firebase !== 'undefined' ? 'âœ… ChargÃ©' : 'âŒ Non chargÃ©'}</p>
                <p>Configuration Firebase: ${window.firebaseConfig ? 'âœ… Disponible' : 'âŒ Manquante'}</p>
                <p>Auth Firebase: ${window.auth ? 'âœ… InitialisÃ©' : 'âŒ Non initialisÃ©'}</p>
                <p>Firestore: ${window.db ? 'âœ… InitialisÃ©' : 'âŒ Non initialisÃ©'}</p>
                <p>Storage: ${window.storage ? 'âœ… InitialisÃ©' : 'âŒ Non initialisÃ©'}</p>
                <p>LocalStorage: ${typeof localStorage !== 'undefined' ? 'âœ… Disponible' : 'âŒ Indisponible'}</p>
                <p>IndexedDB: ${typeof indexedDB !== 'undefined' ? 'âœ… Disponible' : 'âŒ Indisponible'}</p>
            `;
        }

        // Force logout
        async function forceLogout() {
            try {
                if (window.auth) {
                    await window.auth.signOut();
                }
                localStorage.clear();
                sessionStorage.clear();
                alert('âœ… DÃ©connexion forcÃ©e rÃ©ussie. Redirection vers la page de connexion...');
                window.location.href = '/login.html';
            } catch (error) {
                alert('âŒ Erreur lors de la dÃ©connexion: ' + error.message);
            }
        }

        // Check browser support
        function checkBrowserSupport() {
            const features = {
                'JavaScript': typeof window !== 'undefined',
                'LocalStorage': typeof localStorage !== 'undefined',
                'SessionStorage': typeof sessionStorage !== 'undefined',
                'IndexedDB': typeof indexedDB !== 'undefined',
                'Fetch API': typeof fetch !== 'undefined',
                'Promises': typeof Promise !== 'undefined',
                'ES6 Classes': typeof class {} === 'function',
                'Service Workers': 'serviceWorker' in navigator
            };

            let report = 'Support du navigateur:\n\n';
            for (const [feature, supported] of Object.entries(features)) {
                report += `${feature}: ${supported ? 'âœ… SupportÃ©' : 'âŒ Non supportÃ©'}\n`;
            }

            alert(report);
        }

        // Clear all browser data
        function clearAllBrowserData() {
            if (confirm('âš ï¸ Attention! Ceci va supprimer TOUTES les donnÃ©es de ce site (connexions, prÃ©fÃ©rences, etc.).\n\nÃŠtes-vous sÃ»r de vouloir continuer?')) {
                clearFirebaseCache().then(() => {
                    alert('ğŸ‰ Toutes les donnÃ©es ont Ã©tÃ© supprimÃ©es. La page va se recharger.');
                    window.location.reload();
                });
            }
        }

        // Generate diagnostic report
        function generateDiagnosticReport() {
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                firebase: {
                    sdkLoaded: typeof firebase !== 'undefined',
                    version: typeof firebase !== 'undefined' ? firebase.SDK_VERSION : 'N/A',
                    config: !!window.firebaseConfig,
                    auth: !!window.auth,
                    firestore: !!window.db,
                    storage: !!window.storage
                },
                storage: {
                    localStorage: Object.keys(localStorage),
                    sessionStorage: Object.keys(sessionStorage)
                },
                errors: [] // Could be populated by error handlers
            };

            document.getElementById('diagnosticInfo').textContent = JSON.stringify(report, null, 2);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkSystemStatus();
            
            // Auto-generate diagnostic report
            setTimeout(generateDiagnosticReport, 1000);
            
            // Add event listeners for all buttons
            document.getElementById('checkStatusBtn')?.addEventListener('click', checkSystemStatus);
            document.getElementById('clearCacheBtn')?.addEventListener('click', clearFirebaseCache);
            document.getElementById('reloadPageBtn')?.addEventListener('click', () => window.location.reload());
            document.getElementById('forceLogoutBtn')?.addEventListener('click', forceLogout);
            document.getElementById('goToLoginBtn')?.addEventListener('click', () => window.location.href = '/login.html');
            document.getElementById('checkBrowserBtn')?.addEventListener('click', checkBrowserSupport);
            document.getElementById('clearAllDataBtn')?.addEventListener('click', clearAllBrowserData);
            document.getElementById('generateReportBtn')?.addEventListener('click', generateDiagnosticReport);
        });
    </script>
</body>
</html> 