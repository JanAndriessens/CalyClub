<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©pannage - CalyBase</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .troubleshoot-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .issue-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .solution-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: bold;
        }
        .solution-button:hover {
            background: #0056b3;
        }
        .danger-button {
            background: #dc3545;
        }
        .danger-button:hover {
            background: #c82333;
        }
        .success-button {
            background: #28a745;
        }
        .success-button:hover {
            background: #218838;
        }
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ok {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-unknown {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo-container">
            <div class="logo-image">
                <img src="images/CalypsoDC-VerticPos_rvb.png" alt="CalypsoDC Logo">
            </div>
            <div class="logo-text-container">
                <div class="logo-text">CalyBase</div>
                <div class="username-text" id="usernameText" style="display: none;"></div>
            </div>
        </div>
        <div class="nav-links">
            <a href="/">Accueil</a>
            <a href="/membres.html">Membres</a>
            <a href="/login.html">D√©connexion</a>
        </div>
    </nav>

    <div class="troubleshoot-container">
        <h1>üîß D√©pannage CalyBase</h1>
        <p>Cette page vous aide √† r√©soudre les probl√®mes courants avec CalyBase.</p>

        <!-- System Status -->
        <div class="issue-card">
            <h3>üìä √âtat du syst√®me</h3>
            <div id="systemStatus">
                <p>V√©rification en cours...</p>
            </div>
            <button class="solution-button" id="checkStatusBtn">üîÑ V√©rifier l'√©tat</button>
        </div>

        <!-- Firebase Issues -->
        <div class="issue-card">
            <h3>üî• Probl√®mes Firebase</h3>
            <p><strong>Sympt√¥mes:</strong></p>
            <ul>
                <li>Message "firebase.storage is not a function"</li>
                <li>Erreur de persistance Firestore</li>
                <li>Donn√©es en cache obsol√®tes</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <button class="solution-button danger-button" id="clearCacheBtn">üßπ Nettoyer le cache Firebase</button>
            <button class="solution-button" id="reloadPageBtn">üîÑ Actualiser la page</button>
        </div>

        <!-- Authentication Issues -->
        <div class="issue-card">
            <h3>üîê Probl√®mes d'authentification</h3>
            <p><strong>Sympt√¥mes:</strong></p>
            <ul>
                <li>Impossible de se connecter</li>
                <li>D√©connexion automatique</li>
                <li>Pages prot√©g√©es inaccessibles</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <button class="solution-button" id="forceLogoutBtn">üö™ Forcer la d√©connexion</button>
            <button class="solution-button success-button" id="goToLoginBtn">üë§ Aller √† la connexion</button>
        </div>

        <!-- Browser Issues -->
        <div class="issue-card">
            <h3>üåê Probl√®mes de navigateur</h3>
            <p><strong>Sympt√¥mes:</strong></p>
            <ul>
                <li>Pages qui ne se chargent pas</li>
                <li>JavaScript d√©sactiv√©</li>
                <li>Cookies bloqu√©s</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <button class="solution-button" id="checkBrowserBtn">üîç V√©rifier le navigateur</button>
            <button class="solution-button danger-button" id="clearAllDataBtn">üóëÔ∏è Vider tout le cache navigateur</button>
        </div>

        <!-- Manual Diagnostics -->
        <div class="issue-card">
            <h3>ü©∫ Diagnostics</h3>
            <p>Informations techniques pour le support:</p>
            <div id="diagnosticInfo" style="background: #f1f3f4; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
            Cliquez sur "G√©n√©rer rapport" pour afficher les informations de diagnostic
            </div>
            <button class="solution-button" id="generateReportBtn">üìã G√©n√©rer rapport de diagnostic</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="firebase-config.js"></script>
    <script src="clear-cache.js"></script>
    <script src="firebase-app.js"></script>
    <script src="navigation.js"></script>

    <script>
        // System status check
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = `
                <p>Firebase SDK: ${typeof firebase !== 'undefined' ? '‚úÖ Charg√©' : '‚ùå Non charg√©'}</p>
                <p>Configuration Firebase: ${window.firebaseConfig ? '‚úÖ Disponible' : '‚ùå Manquante'}</p>
                <p>Auth Firebase: ${window.auth ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}</p>
                <p>Firestore: ${window.db ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}</p>
                <p>Storage: ${window.storage ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}</p>
                <p>LocalStorage: ${typeof localStorage !== 'undefined' ? '‚úÖ Disponible' : '‚ùå Indisponible'}</p>
                <p>IndexedDB: ${typeof indexedDB !== 'undefined' ? '‚úÖ Disponible' : '‚ùå Indisponible'}</p>
            `;
        }

        // Force logout
        async function forceLogout() {
            try {
                if (window.auth) {
                    await window.auth.signOut();
                }
                localStorage.clear();
                sessionStorage.clear();
                alert('‚úÖ D√©connexion forc√©e r√©ussie. Redirection vers la page de connexion...');
                window.location.href = '/login.html';
            } catch (error) {
                alert('‚ùå Erreur lors de la d√©connexion: ' + error.message);
            }
        }

        // Check browser support
        function checkBrowserSupport() {
            const features = {
                'JavaScript': typeof window !== 'undefined',
                'LocalStorage': typeof localStorage !== 'undefined',
                'SessionStorage': typeof sessionStorage !== 'undefined',
                'IndexedDB': typeof indexedDB !== 'undefined',
                'Fetch API': typeof fetch !== 'undefined',
                'Promises': typeof Promise !== 'undefined',
                'ES6 Classes': typeof class {} === 'function',
                'Service Workers': 'serviceWorker' in navigator
            };

            let report = 'Support du navigateur:\n\n';
            for (const [feature, supported] of Object.entries(features)) {
                report += `${feature}: ${supported ? '‚úÖ Support√©' : '‚ùå Non support√©'}\n`;
            }

            alert(report);
        }

        // Clear all browser data
        function clearAllBrowserData() {
            if (confirm('‚ö†Ô∏è Attention! Ceci va supprimer TOUTES les donn√©es de ce site (connexions, pr√©f√©rences, etc.).\n\n√ätes-vous s√ªr de vouloir continuer?')) {
                clearFirebaseCache().then(() => {
                    alert('üéâ Toutes les donn√©es ont √©t√© supprim√©es. La page va se recharger.');
                    window.location.reload();
                });
            }
        }

        // Generate diagnostic report
        function generateDiagnosticReport() {
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                firebase: {
                    sdkLoaded: typeof firebase !== 'undefined',
                    version: typeof firebase !== 'undefined' ? firebase.SDK_VERSION : 'N/A',
                    config: !!window.firebaseConfig,
                    auth: !!window.auth,
                    firestore: !!window.db,
                    storage: !!window.storage
                },
                storage: {
                    localStorage: Object.keys(localStorage),
                    sessionStorage: Object.keys(sessionStorage)
                },
                errors: [] // Could be populated by error handlers
            };

            document.getElementById('diagnosticInfo').textContent = JSON.stringify(report, null, 2);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkSystemStatus();
            
            // Auto-generate diagnostic report
            setTimeout(generateDiagnosticReport, 1000);
            
            // Add event listeners for all buttons
            document.getElementById('checkStatusBtn')?.addEventListener('click', checkSystemStatus);
            document.getElementById('clearCacheBtn')?.addEventListener('click', clearFirebaseCache);
            document.getElementById('reloadPageBtn')?.addEventListener('click', () => window.location.reload());
            document.getElementById('forceLogoutBtn')?.addEventListener('click', forceLogout);
            document.getElementById('goToLoginBtn')?.addEventListener('click', () => window.location.href = '/login.html');
            document.getElementById('checkBrowserBtn')?.addEventListener('click', checkBrowserSupport);
            document.getElementById('clearAllDataBtn')?.addEventListener('click', clearAllBrowserData);
            document.getElementById('generateReportBtn')?.addEventListener('click', generateDiagnosticReport);
        });
    </script>
</body>
</html> 