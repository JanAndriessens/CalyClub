<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Storage - CalyClub</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; border-radius: 8px; }
        .upload-area.dragover { border-color: #4285f4; background: #f0f7ff; }
        .result { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #4285f4; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #3367d6; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        input[type="file"] { margin: 10px 0; }
        .progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 10px 0; }
        .progress-bar { height: 100%; background: #4285f4; border-radius: 10px; transition: width 0.3s; }
    </style>
</head>
<body>
    <h1>üóÑÔ∏è Test Firebase Storage - CalyClub</h1>
    <p>Test file upload functionality for avatars and documents.</p>

    <button onclick="signIn()" id="signInBtn">Sign In First</button>
    
    <div id="uploadSection" style="display: none;">
        <h3>üì§ Upload Test File</h3>
        
        <div class="upload-area" id="uploadArea">
            <p>üìÅ Click to select file or drag & drop</p>
            <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx" />
        </div>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        
        <button onclick="uploadFile()" id="uploadBtn" disabled>Upload File</button>
        <button onclick="listFiles()">List Files</button>
    </div>

    <div id="result"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAJHe5b04puLllWJAlqQz9or-Dz4cvs2gU",
            authDomain: "calyclub-72808.firebaseapp.com",
            projectId: "calyclub-72808",
            storageBucket: "calyclub-72808.firebasestorage.app",
            messagingSenderId: "496335267337",
            appId: "1:496335267337:web:a92d7f2447ced926243ad8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        let selectedFile = null;
        
        // Elements
        const signInBtn = document.getElementById('signInBtn');
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const resultDiv = document.getElementById('result');
        const uploadArea = document.getElementById('uploadArea');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        // Sign in
        async function signIn() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                
                signInBtn.textContent = '‚úÖ Signed In';
                signInBtn.disabled = true;
                uploadSection.style.display = 'block';
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Signed In Successfully!</h3>
                        <p><strong>Email:</strong> ${result.user.email}</p>
                        <p>You can now test file uploads.</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Sign in error:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Sign In Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // File selection
        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                uploadBtn.disabled = false;
                uploadBtn.textContent = `Upload ${selectedFile.name}`;
                
                resultDiv.innerHTML = `
                    <div class="result info">
                        <h3>üìÑ File Selected</h3>
                        <p><strong>Name:</strong> ${selectedFile.name}</p>
                        <p><strong>Size:</strong> ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB</p>
                        <p><strong>Type:</strong> ${selectedFile.type}</p>
                    </div>
                `;
            }
        });

        // Drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                fileInput.files = files;
                uploadBtn.disabled = false;
                uploadBtn.textContent = `Upload ${selectedFile.name}`;
            }
        });

        // Upload file
        async function uploadFile() {
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            if (!auth.currentUser) {
                alert('Please sign in first');
                return;
            }

            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';
                progressContainer.style.display = 'block';
                
                // Create storage reference
                const timestamp = Date.now();
                const fileName = `test-${timestamp}-${selectedFile.name}`;
                const storageRef = storage.ref().child(`test-uploads/${fileName}`);
                
                // Upload file with progress tracking
                const uploadTask = storageRef.put(selectedFile);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Progress
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                        uploadBtn.textContent = `Uploading... ${Math.round(progress)}%`;
                    },
                    (error) => {
                        // Error
                        console.error('Upload error:', error);
                        resultDiv.innerHTML = `
                            <div class="result error">
                                <h3>‚ùå Upload Error</h3>
                                <p><strong>Error:</strong> ${error.message}</p>
                                <p><strong>Code:</strong> ${error.code}</p>
                            </div>
                        `;
                        
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload File';
                        progressContainer.style.display = 'none';
                    },
                    async () => {
                        // Success
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            
                            resultDiv.innerHTML = `
                                <div class="result success">
                                    <h3>üéâ Upload Successful!</h3>
                                    <p><strong>File:</strong> ${selectedFile.name}</p>
                                    <p><strong>Size:</strong> ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB</p>
                                    <p><strong>Path:</strong> test-uploads/${fileName}</p>
                                    <p><strong>Download URL:</strong> <a href="${downloadURL}" target="_blank">View File</a></p>
                                </div>
                            `;
                            
                        } catch (error) {
                            console.error('Error getting download URL:', error);
                        }
                        
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload Another File';
                        progressContainer.style.display = 'none';
                        selectedFile = null;
                        fileInput.value = '';
                    }
                );
                
            } catch (error) {
                console.error('Upload error:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Upload Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                progressContainer.style.display = 'none';
            }
        }

        // List files
        async function listFiles() {
            if (!auth.currentUser) {
                alert('Please sign in first');
                return;
            }

            try {
                resultDiv.innerHTML = '<div class="result info">Loading files...</div>';
                
                const listRef = storage.ref().child('test-uploads');
                const result = await listRef.listAll();
                
                if (result.items.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="result info">
                            <h3>üìÅ No Files Found</h3>
                            <p>Upload a file first to see it listed here.</p>
                        </div>
                    `;
                    return;
                }
                
                let fileList = '<h3>üìÅ Uploaded Files</h3><ul>';
                for (const item of result.items) {
                    try {
                        const url = await item.getDownloadURL();
                        fileList += `<li><a href="${url}" target="_blank">${item.name}</a></li>`;
                    } catch (error) {
                        fileList += `<li>${item.name} (error getting URL)</li>`;
                    }
                }
                fileList += '</ul>';
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        ${fileList}
                    </div>
                `;
                
            } catch (error) {
                console.error('List files error:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå List Files Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Auto-sign in if already authenticated
        auth.onAuthStateChanged((user) => {
            if (user) {
                signInBtn.textContent = '‚úÖ Already Signed In';
                signInBtn.disabled = true;
                uploadSection.style.display = 'block';
            }
        });

        // Make upload area clickable
        uploadArea.addEventListener('click', () => {
            if (auth.currentUser) {
                fileInput.click();
            }
        });
    </script>
</body>
</html>