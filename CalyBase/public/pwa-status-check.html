<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Status Check - CalyBase</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0066cc">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-ok { border-left: 4px solid #28a745; }
        .status-warning { border-left: 4px solid #ffc107; }
        .status-error { border-left: 4px solid #dc3545; }
        .status-info { border-left: 4px solid #17a2b8; }
        h1 { color: #0066cc; text-align: center; }
        h2 { margin-top: 0; color: #333; }
        .button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover { background: #0052a3; }
        .code { 
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
        .installation-steps {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .installation-steps h3 {
            margin-top: 0;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <h1>üì± CalyBase PWA Status Check</h1>

    <div class="status-card status-info">
        <h2>üîç Current Status</h2>
        <p id="current-status">Checking PWA capabilities...</p>
    </div>

    <div class="status-card" id="manifest-card">
        <h2>üìã Manifest Check</h2>
        <p id="manifest-status">Checking manifest.json...</p>
    </div>

    <div class="status-card" id="sw-card">
        <h2>‚öôÔ∏è Service Worker Check</h2>
        <p id="sw-status">Checking service worker...</p>
    </div>

    <div class="status-card" id="install-card">
        <h2>üì± Installation Check</h2>
        <p id="install-status">Checking installation capability...</p>
        <button id="install-btn" class="button" onclick="triggerInstall()" style="display: none;">Install PWA</button>
    </div>

    <div class="status-card" id="https-card">
        <h2>üîí HTTPS Status</h2>
        <p id="https-status">Checking secure connection...</p>
    </div>

    <div class="installation-steps">
        <h3>üìñ How to Test PWA Features</h3>
        
        <h4>üåê Current Setup (File-based):</h4>
        <p>You're currently testing from the file system. For full PWA features, deploy to:</p>
        <div class="code">
            # Firebase (recommended):
            firebase login
            firebase deploy --only hosting
            
            # Or local HTTPS server:
            # Install local-ssl-proxy: npm install -g local-ssl-proxy
            # Then: local-ssl-proxy --source 8080 --target 8000
        </div>
        
        <h4>üì± Mobile Testing:</h4>
        <ol>
            <li><strong>Android Chrome:</strong> Look for "Add to Home Screen" banner</li>
            <li><strong>iOS Safari:</strong> Share button ‚Üí "Add to Home Screen"</li>
            <li><strong>Desktop Chrome:</strong> Install icon in address bar</li>
        </ol>
        
        <h4>‚úÖ What to Test:</h4>
        <ul>
            <li>Install the app from browser</li>
            <li>Open installed app (should look different than browser)</li>
            <li>Try app in airplane mode (offline test)</li>
            <li>Check if notifications work</li>
        </ul>
    </div>

    <div class="status-card">
        <h2>üöÄ Quick Actions</h2>
        <a href="index.html" class="button">Main App</a>
        <a href="membres.html" class="button">Members</a>
        <a href="events.html" class="button">Events</a>
        <a href="login.html" class="button">Login</a>
        <button class="button" onclick="location.reload()">Refresh Check</button>
    </div>

    <script>
        // Check current status
        function updateCurrentStatus() {
            const protocol = window.location.protocol;
            const isHTTPS = protocol === 'https:';
            const isLocalhost = window.location.hostname === 'localhost';
            const isFile = protocol === 'file:';
            
            let status = '';
            let cardClass = '';
            
            if (isHTTPS) {
                status = '‚úÖ HTTPS - Full PWA features available';
                cardClass = 'status-ok';
            } else if (isLocalhost) {
                status = '‚ö†Ô∏è HTTP Localhost - Most PWA features work';
                cardClass = 'status-warning';
            } else if (isFile) {
                status = '‚ö†Ô∏è File Protocol - Limited PWA features';
                cardClass = 'status-warning';
            } else {
                status = '‚ùå HTTP - PWA features disabled for security';
                cardClass = 'status-error';
            }
            
            document.getElementById('current-status').textContent = status;
            document.querySelector('.status-card').className = `status-card ${cardClass}`;
        }

        // Check manifest
        function checkManifest() {
            fetch('./manifest.json')
                .then(response => response.json())
                .then(manifest => {
                    document.getElementById('manifest-status').innerHTML = 
                        `‚úÖ Manifest loaded successfully<br>
                         <strong>App:</strong> ${manifest.name}<br>
                         <strong>Icons:</strong> ${manifest.icons.length} sizes available`;
                    document.getElementById('manifest-card').className = 'status-card status-ok';
                })
                .catch(error => {
                    document.getElementById('manifest-status').textContent = 
                        '‚ùå Manifest not found or invalid: ' + error.message;
                    document.getElementById('manifest-card').className = 'status-card status-error';
                });
        }

        // Check service worker
        function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        document.getElementById('sw-status').innerHTML = 
                            `‚úÖ Service Worker registered<br>
                             <strong>Scope:</strong> ${registration.scope}`;
                        document.getElementById('sw-card').className = 'status-card status-ok';
                    })
                    .catch(error => {
                        document.getElementById('sw-status').textContent = 
                            '‚ùå Service Worker failed: ' + error.message;
                        document.getElementById('sw-card').className = 'status-card status-error';
                    });
            } else {
                document.getElementById('sw-status').textContent = 
                    '‚ùå Service Workers not supported';
                document.getElementById('sw-card').className = 'status-card status-error';
            }
        }

        // Check installation
        function checkInstallation() {
            // Check if already installed
            if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('install-status').textContent = 
                    '‚úÖ App is already installed (running in standalone mode)';
                document.getElementById('install-card').className = 'status-card status-ok';
                return;
            }

            // Check for install prompt capability
            let status = '';
            let cardClass = '';

            if (window.location.protocol === 'https:' || window.location.hostname === 'localhost') {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS) {
                    status = 'üì± iOS detected - Use Safari "Add to Home Screen"';
                    cardClass = 'status-info';
                } else {
                    status = '‚è≥ Installation ready - Banner will appear when criteria met';
                    cardClass = 'status-warning';
                    
                    // Show install button for testing
                    document.getElementById('install-btn').style.display = 'inline-block';
                }
            } else {
                status = '‚ùå HTTPS required for installation';
                cardClass = 'status-error';
            }

            document.getElementById('install-status').textContent = status;
            document.getElementById('install-card').className = `status-card ${cardClass}`;
        }

        // Check HTTPS
        function checkHTTPS() {
            const protocol = window.location.protocol;
            let status = '';
            let cardClass = '';

            if (protocol === 'https:') {
                status = '‚úÖ Secure HTTPS connection - All PWA features available';
                cardClass = 'status-ok';
            } else if (window.location.hostname === 'localhost') {
                status = '‚ö†Ô∏è HTTP on localhost - PWA features work for development';
                cardClass = 'status-warning';
            } else {
                status = '‚ùå HTTP connection - Deploy to HTTPS for full PWA features';
                cardClass = 'status-error';
            }

            document.getElementById('https-status').textContent = status;
            document.getElementById('https-card').className = `status-card ${cardClass}`;
        }

        // Install trigger
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'inline-block';
            document.getElementById('install-status').textContent = 
                '‚úÖ Ready to install! Click the install button.';
            document.getElementById('install-card').className = 'status-card status-ok';
        });

        function triggerInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('install-status').textContent = 
                            '‚úÖ App installation accepted!';
                    } else {
                        document.getElementById('install-status').textContent = 
                            '‚ö†Ô∏è App installation cancelled';
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('Installation prompt not available. Try:\n\n' +
                      'iOS: Share button ‚Üí Add to Home Screen\n' +
                      'Android: Menu ‚Üí Add to Home Screen\n' +
                      'Desktop: Install icon in address bar');
            }
        }

        // Run all checks
        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentStatus();
            checkManifest();
            checkServiceWorker();
            checkInstallation();
            checkHTTPS();
        });
    </script>
</body>
</html>