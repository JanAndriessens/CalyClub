<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'Authentification - CalyBase</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-box {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .auth-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">CalyBase</div>
        <div class="nav-links">
            <a href="/">Accueil</a>
            <a href="/membres.html">Membres</a>
            <a href="/events.html">√âv√©nements</a>
            <a href="/auth-test.html" class="active">Test Auth</a>
            <a href="/login.html" id="authLink">D√©connexion</a>
        </div>
    </nav>

    <div class="test-container">
        <h1>üîê Test d'Authentification CalyBase</h1>
        <p>Cette page teste le syst√®me d'authentification et de navigation.</p>

        <div id="authStatus" class="status-box status-info">
            V√©rification en cours...
        </div>

        <div class="auth-details">
            <h3>üìä √âtat de l'authentification:</h3>
            <div id="authDetails">Chargement...</div>
        </div>

        <div class="auth-details">
            <h3>üîß √âtat de Firebase:</h3>
            <div id="firebaseStatus">Chargement...</div>
        </div>

        <div class="auth-details">
            <h3>üîç Navigation:</h3>
            <div id="navigationStatus">Chargement...</div>
        </div>

        <div class="auth-details">
            <h3>üîí Test de verrouillage de compte:</h3>
            <div id="lockoutStatus">Chargement...</div>
            <div style="margin-top: 10px;">
                <input type="email" id="testEmail" placeholder="Email √† tester" style="
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    margin-right: 10px;
                    width: 200px;
                ">
                <button id="checkLockoutBtn" style="
                    background: #17a2b8;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    margin: 2px;
                ">üîç V√©rifier</button>
                <button id="simulateFailBtn" style="
                    background: #ffc107;
                    color: #212529;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    margin: 2px;
                ">‚ö†Ô∏è Simuler √©chec</button>
                <button id="resetLockoutBtn" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    margin: 2px;
                ">‚úÖ Reset</button>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button id="refreshTest" style="
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px;
            ">üîÑ Rafra√Æchir le test</button>
            
            <button id="testLogout" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px;
            ">üö™ Tester D√©connexion</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-app.js"></script>
    <script src="auth-guard.js"></script>
    <script src="account-lockout-client.js"></script>

    <script>
        // Update lockout test status
        async function updateLockoutTest() {
            const lockoutStatusDiv = document.getElementById('lockoutStatus');
            
            if (!window.accountLockout || !window.db) {
                lockoutStatusDiv.innerHTML = '‚ùå Service de verrouillage non disponible';
                return;
            }
            
            lockoutStatusDiv.innerHTML = `
                Service de verrouillage: ‚úÖ Actif<br>
                Max tentatives √©chou√©es: ${window.accountLockout.MAX_FAILED_ATTEMPTS}<br>
                Dur√©e de verrouillage: ${window.accountLockout.LOCKOUT_DURATION / 60000} minutes<br>
                <small>Utilisez les boutons ci-dessous pour tester avec une adresse email</small>
            `;
        }

        // Test authentication status
        function updateAuthTest() {
            const authStatusDiv = document.getElementById('authStatus');
            const authDetailsDiv = document.getElementById('authDetails');
            const firebaseStatusDiv = document.getElementById('firebaseStatus');
            const navigationStatusDiv = document.getElementById('navigationStatus');

            // Check authentication
            if (window.authGuard && window.authGuard.isAuthenticated()) {
                const user = window.authGuard.getCurrentUser();
                authStatusDiv.className = 'status-box status-success';
                authStatusDiv.innerHTML = `‚úÖ AUTHENTIFI√â - ${user.email}`;
                
                authDetailsDiv.innerHTML = `
                    Utilisateur: ${user.email}<br>
                    UID: ${user.uid}<br>
                    Email v√©rifi√©: ${user.emailVerified ? 'Oui' : 'Non'}<br>
                    Derni√®re connexion: ${user.metadata?.lastSignInTime || 'N/A'}<br>
                    Cr√©ation: ${user.metadata?.creationTime || 'N/A'}
                `;
            } else if (window.authGuard && window.authGuard.isInitialized) {
                authStatusDiv.className = 'status-box status-error';
                authStatusDiv.innerHTML = '‚ùå NON AUTHENTIFI√â';
                authDetailsDiv.innerHTML = 'Aucun utilisateur connect√©';
            } else {
                authStatusDiv.className = 'status-box status-info';
                authStatusDiv.innerHTML = '‚è≥ V√âRIFICATION EN COURS...';
                authDetailsDiv.innerHTML = 'AuthGuard en cours d\'initialisation...';
            }

            // Check Firebase status
            firebaseStatusDiv.innerHTML = `
                Firebase App: ${typeof firebase !== 'undefined' ? '‚úÖ Charg√©' : '‚ùå Non charg√©'}<br>
                Firebase Config: ${window.firebaseConfig ? '‚úÖ Disponible' : '‚ùå Manquante'}<br>
                Auth: ${window.auth ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}<br>
                Firestore: ${window.db ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}<br>
                Storage: ${window.storage ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}<br>
                AuthGuard: ${window.authGuard ? '‚úÖ Disponible' : '‚ùå Non disponible'}<br>
                AccountLockout: ${window.accountLockout ? '‚úÖ Disponible' : '‚ùå Non disponible'}
            `;

            // Check navigation
            const authLink = document.getElementById('authLink');
            const navLinks = document.querySelector('.nav-links');
            
            navigationStatusDiv.innerHTML = `
                Element nav-links: ${navLinks ? '‚úÖ Trouv√©' : '‚ùå Manquant'}<br>
                Element authLink: ${authLink ? '‚úÖ Trouv√©' : '‚ùå Manquant'}<br>
                Texte du lien: "${authLink ? authLink.textContent : 'N/A'}"<br>
                Href du lien: "${authLink ? authLink.href : 'N/A'}"<br>
                Classes CSS: "${authLink ? authLink.className : 'N/A'}"
            `;
        }

        // Initialize test
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ Auth test page loaded');
            
            // Initial test
            setTimeout(() => {
                updateAuthTest();
                updateLockoutTest();
            }, 1000);
            
            // Update test every 2 seconds
            setInterval(() => {
                updateAuthTest();
                updateLockoutTest();
            }, 2000);
            
            // Refresh button
            document.getElementById('refreshTest').addEventListener('click', () => {
                updateAuthTest();
                updateLockoutTest();
            });
            
            // Test logout button
            document.getElementById('testLogout').addEventListener('click', () => {
                if (window.authGuard && window.authGuard.isAuthenticated()) {
                    console.log('üß™ Testing logout...');
                    window.authGuard.logout();
                } else {
                    alert('Aucun utilisateur connect√© √† d√©connecter');
                }
            });

            // Lockout testing buttons
            document.getElementById('checkLockoutBtn').addEventListener('click', async () => {
                const email = document.getElementById('testEmail').value;
                if (!email) {
                    alert('Veuillez entrer une adresse email');
                    return;
                }
                
                console.log('üîç Checking lockout status for:', email);
                if (window.checkLockoutStatus) {
                    await window.checkLockoutStatus(email);
                } else {
                    console.log('‚ùå checkLockoutStatus function not available');
                }
            });

            document.getElementById('simulateFailBtn').addEventListener('click', async () => {
                const email = document.getElementById('testEmail').value;
                if (!email) {
                    alert('Veuillez entrer une adresse email');
                    return;
                }
                
                if (!window.accountLockout) {
                    alert('Service de verrouillage non disponible');
                    return;
                }
                
                try {
                    console.log('‚ö†Ô∏è Simulating failed login attempt for:', email);
                    await window.accountLockout.recordFailedAttempt(email);
                    console.log('‚úÖ Failed attempt recorded');
                    
                    // Check status after recording
                    const attempts = await window.accountLockout.getFailedAttempts(email);
                    alert(`Tentative √©chou√©e enregistr√©e. Total: ${attempts}/5`);
                } catch (error) {
                    console.log('üîí Lockout triggered:', error.message);
                    alert(`COMPTE VERROUILL√â: ${error.message}`);
                }
            });

            document.getElementById('resetLockoutBtn').addEventListener('click', async () => {
                const email = document.getElementById('testEmail').value;
                if (!email) {
                    alert('Veuillez entrer une adresse email');
                    return;
                }
                
                if (!window.accountLockout) {
                    alert('Service de verrouillage non disponible');
                    return;
                }
                
                try {
                    console.log('‚úÖ Resetting lockout for:', email);
                    await window.accountLockout.resetFailedAttempts(email);
                    alert('Verrouillage supprim√© avec succ√®s');
                } catch (error) {
                    console.error('Error resetting lockout:', error);
                    alert('Erreur lors de la suppression du verrouillage');
                }
            });
        });

        // Listen for auth state changes
        window.addEventListener('firebaseInitialized', () => {
            console.log('üß™ Firebase initialized, updating test');
            setTimeout(() => {
                updateAuthTest();
                updateLockoutTest();
            }, 500);
        });
    </script>
</body>
</html> 